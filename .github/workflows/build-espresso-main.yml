name: Build Espresso dev node

on: push

jobs:
  build-espresso-dev-node:
    name: Build Espresso dev node
    runs-on: ubuntu-latest
    env:
      COMPOSE_BAKE: true
      TARGETARCH: amd64
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Checkout espresso dev node
        run: |
          git clone --depth 1 https://github.com/EspressoSystems/espresso-network.git

      - name: Cargo build espresso dev node
        run: |
          cd espresso-network
          cargo build --locked --release --features "testing embedded-db" --bin espresso-dev-node
          mkdir -p target/$TARGETARCH/release
          cp target/release/espresso-dev-node target/$TARGETARCH/release/espresso-dev-node

      # - name: Docker build espresso dev node
      #   run: |
      #     cd espresso-network
      #     ls -la target/release
      #     docker buildx build \
      #       --build-arg TARGETARCH=${TARGETARCH} \
      #       --file ./docker/espresso-dev-node.Dockerfile \
      #       --output type=docker,dest=/home/runner/work/_temp/espresso-dev-node.tar \
      #       --tag espresso-dev-node:ctsi .

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/calindra/espresso-dev-node

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./espresso-network
          file: ./espresso-network/docker/espresso-dev-node.Dockerfile
          push: true
          repository: calindra/espresso-dev-node
          registry: ghcr.io
          build-args: |
            TARGETARCH=amd64
          tags: |
            ghcr.io/calindra/espresso-dev-node:ctsi
          labels: ${{ steps.meta.outputs.labels }}

      - name: Run docker compose
        run: |
          docker compose up espresso-dev-node sequencer-db-0 devnet -d

      - name: Wait for a while, log and shutdown
        run: |
          sleep 300
          docker compose logs --timestamps espresso-dev-node
          docker compose down

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add ./dump
          git commit -m "chore: automated update [skip ci]" || echo "Nothing to commit"
          git push origin HEAD:${{ github.ref_name }}
